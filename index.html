<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkOn - Network Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
:root{--bg:#f0f2f5;--card:#fff;--text:#000;--primary:#007bff;--alert:#ff4d4d;--warn:#ffa500;--good:#28c76f;}
body.dark{--bg:#1e1e2f;--card:#2e2e3e;--text:#fff;--primary:#4ea3ff;}
body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:10px;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
#statusBanner{width:100%;max-width:700px;text-align:center;padding:10px;border-radius:12px;margin:0 auto 10px auto;font-weight:bold;color:#fff;font-size:16px;}
.header{width:100%;max-width:700px;display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:10px;}
.header h1{margin:0;font-size:26px;}
.toggle-btn{position:absolute;right:0;top:0;width:45px;height:45px;border-radius:50%;border:2px solid var(--primary);background:var(--bg);display:flex;justify-content:center;align-items:center;cursor:pointer;font-weight:bold;}
.tabs{display:flex;width:100%;max-width:700px;margin-bottom:10px;overflow-x:auto;}
.tab-btn{flex:1;padding:10px;background:var(--card);border:none;border-bottom:2px solid transparent;cursor:pointer;}
.tab-btn.active{border-bottom:2px solid var(--primary);}
.container{max-width:700px;width:100%;}
.card{background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
.card h2{margin:0 0 10px 0;font-size:20px;}
.info{display:flex;justify-content:space-between;font-size:16px;margin:6px 0;flex-wrap:wrap;align-items:center;}
.value{display:flex;gap:4px;}
button{padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:#fff;margin:5px 5px 0 0;}
canvas{margin-top:20px;max-width:100%;}
#map{height:300px;border-radius:12px;margin-top:20px;width:100%;}
.alert{font-weight:bold;}
footer{text-align:center;font-size:14px;color:var(--text);margin-top:10px;}
input{width:60px;padding:5px;margin-left:5px;border-radius:4px;border:1px solid #ccc;}
.server-input{width:calc(100% - 100px);margin-right:5px;padding:5px;border-radius:4px;border:1px solid #ccc;}
.server-row{display:flex;margin-bottom:5px;align-items:center;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
table th,table td{border:1px solid #ccc;padding:5px;text-align:center;}
</style>
</head>
<body>

<div id="statusBanner">Loading Network Status...</div>

<div class="header">
  <h1>LinkOn</h1>
  <button class="toggle-btn" id="themeToggle" onclick="toggleTheme()">ðŸŒ™</button>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab(event,'info')">Network Info</button>
  <button class="tab-btn" onclick="showTab(event,'charts')">Charts</button>
  <button class="tab-btn" onclick="showTab(event,'servers')">Servers</button>
  <button class="tab-btn" onclick="showTab(event,'settings')">Settings</button>
</div>

<div class="container">
  <!-- Network Info -->
  <div class="card tab-content" id="info">
    <h2>Network Info</h2>
    <div class="info">
      <span>Network Health Score:</span>
      <canvas id="healthGauge" width="150" height="75"></canvas>
      <span id="healthText" style="font-weight:bold; margin-left:10px;">--</span>
    </div>
    <div class="info"><span>IP:</span> <span id="ip">Loading...</span></div>
    <div class="info"><span>ISP:</span> <span id="isp">Loading...</span></div>
    <div class="info"><span>Location:</span> <span id="location">Loading...</span></div>
    <div class="info"><span>Ping:</span> <span class="value"><span id="ping">--</span> ms</span></div>
    <div class="info"><span>Jitter:</span> <span class="value"><span id="jitter">--</span> ms</span></div>
    <div class="info"><span>Packet Loss:</span> <span class="value"><span id="packetloss">0</span> %</span></div>
    <div class="info"><span>Download:</span> <span class="value"><span id="download">--</span> Mbps</span></div>
    <div class="info"><span>Upload:</span> <span class="value"><span id="upload">--</span> Mbps</span></div>
    <div class="info"><span>Network Type:</span> <span id="netType">Detecting...</span></div>
    <div class="info alert" id="alerts"></div>
    <button onclick="analyzeNetwork()">Refresh</button>
    <button onclick="exportCSV()">Export CSV</button>
  </div>

  <!-- Charts -->
  <div class="card tab-content" id="charts" style="display:none">
    <h2>Interactive Charts</h2>
    <canvas id="pingChart" height="150"></canvas>
    <canvas id="speedChart" height="150"></canvas>
    <canvas id="serverChart" height="150"></canvas>
  </div>

  <!-- Servers -->
  <div class="card tab-content" id="servers" style="display:none">
    <h2>Custom Servers</h2>
    <div id="serverList"></div>
    <button onclick="addServer()">Add Server</button>
    <h3>Latency Summary</h3>
    <table id="serverTable"><thead><tr><th>Server</th><th>Min(ms)</th><th>Max(ms)</th><th>Avg(ms)</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Settings -->
  <div class="card tab-content" id="settings" style="display:none">
    <h2>Alert Thresholds</h2>
    <div class="info"><span>Ping(ms):</span><input id="thPing" type="number" value="150"></div>
    <div class="info"><span>Jitter(ms):</span><input id="thJitter" type="number" value="30"></div>
    <div class="info"><span>Packet Loss(%):</span><input id="thPacket" type="number" value="5"></div>
    <div class="info"><span>Download(Mbps):</span><input id="thDownload" type="number" value="10"></div>
    <div class="info"><span>Upload(Mbps):</span><input id="thUpload" type="number" value="5"></div>
    <button onclick="saveThresholds()">Save Thresholds</button>
  </div>

  <!-- Map -->
  <div class="card">
    <h2>Server & User Map</h2>
    <div id="map"></div>
  </div>
</div>

<footer>Â© Manik Roy 2025 | All Rights Reserved.</footer>

<script>
// ===== Tabs =====
function showTab(evt,tab){
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  document.getElementById(tab).style.display='block';
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  evt.currentTarget.classList.add('active');
}

// ===== Dark Mode =====
function toggleTheme(){
  document.body.classList.toggle('dark');
  document.getElementById('themeToggle').innerText=document.body.classList.contains('dark')?'â˜€':'ðŸŒ™';
}

// ===== Servers =====
let servers=JSON.parse(localStorage.getItem('servers'))||['https://www.google.com','https://www.cloudflare.com'];
let serverPingHistory={};
function renderServers(){
  const list=document.getElementById('serverList');list.innerHTML='';
  servers.forEach((s,i)=>{
    const row=document.createElement('div');
    row.className='server-row';
    row.innerHTML=`<input class="server-input" value="${s}" onchange="updateServer(${i},this.value)"><button onclick="removeServer(${i})">Remove</button>`;
    list.appendChild(row);
  });
}
function addServer(){servers.push('https://');renderServers();saveServers();}
function removeServer(i){servers.splice(i,1);renderServers();saveServers();}
function updateServer(i,val){servers[i]=val;saveServers();}
function saveServers(){localStorage.setItem('servers',JSON.stringify(servers));renderServerTable();}
function saveThresholds(){localStorage.setItem('thresholds',JSON.stringify({ping:parseInt(document.getElementById('thPing').value),jitter:parseInt(document.getElementById('thJitter').value),packet:parseInt(document.getElementById('thPacket').value),download:parseInt(document.getElementById('thDownload').value),upload:parseInt(document.getElementById('thUpload').value)}));}

// ===== Charts =====
const pingCtx=document.getElementById('pingChart').getContext('2d');
const speedCtx=document.getElementById('speedChart').getContext('2d');
const serverCtx=document.getElementById('serverChart').getContext('2d');
const pingData={labels:[],datasets:[{label:'Ping',data:[],borderColor:'rgba(0,123,255,1)',fill:true,tension:0.3}]};
const speedData={labels:[],datasets:[{label:'Download',data:[],borderColor:'rgba(40,200,100,1)',fill:false},{label:'Upload',data:[],borderColor:'rgba(255,99,132,1)',fill:false}]};
const serverData={labels:[],datasets:[]};
const pingChart=new Chart(pingCtx,{type:'line',data:pingData,options:{responsive:true,plugins:{zoom:{pan:{enabled:true,mode:'x'},zoom:{enabled:true,mode:'x'}}},scales:{y:{beginAtZero:true}}}});
const speedChart=new Chart(speedCtx,{type:'line',data:speedData,options:{responsive:true,plugins:{zoom:{pan:{enabled:true,mode:'x'},zoom:{enabled:true,mode:'x'}}},scales:{y:{beginAtZero:true}}}});
const serverChart=new Chart(serverCtx,{type:'line',data:serverData,options:{responsive:true,plugins:{zoom:{pan:{enabled:true,mode:'x'},zoom:{enabled:true,mode:'x'}}},scales:{y:{beginAtZero:true}}}});

// ===== Health Gauge =====
const healthCtx=document.getElementById('healthGauge').getContext('2d');
const healthData={labels:['Score','Remaining'],datasets:[{data:[0,100],backgroundColor:['var(--good)',' #ccc'],borderWidth:0}]};
const healthGauge=new Chart(healthCtx,{type:'doughnut',data:healthData,options:{rotation:-90,circumference:180,cutout:'70%',plugins:{legend:{display:false}}}});

// ===== Map =====
let map=L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let userMarker=L.marker([0,0]).addTo(map);

// ===== Network Functions =====
async function getIP(){try{const r=await fetch('https://api.ipify.org?format=json');return(await r.json()).ip}catch{return 'N/A';}}
async function getGeoInfo(ip){try{const r=await fetch(`https://ipwhois.app/json/${ip}`);const d=await r.json();return{isp:d.org||'N/A',location:`${d.city||'N/A'}, ${d.region||'N/A'}, ${d.country||'N/A'}`,lat:d.latitude||0,lon:d.longitude||0};}catch{return{isp:'N/A',location:'N/A',lat:0,lon:0};}}
async function getPing(){const s=Date.now();try{await fetch('https://api.ipify.org?format=json');return Date.now()-s}catch{return 0;}}
async function getDownloadSpeed(){try{const img="https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg";const start=Date.now();await fetch(img+"?cache="+Math.random());const dur=(Date.now()-start)/1000;return ((3*8*1024*1024/dur)/(1024*1024)).toFixed(2);}catch{return 0;}}
async function getUploadSpeed(){try{const data=new Blob([new ArrayBuffer(2*1024*1024)]);const start=Date.now();await fetch('https://httpbin.org/post',{method:'POST',body:data});const dur=(Date.now()-start)/1000;return ((2*8*1024*1024/dur)/(1024*1024)).toFixed(2);}catch{return 0;}}
async function measureJitterPacketLoss(times=5){let pings=[],fail=0;for(let i=0;i<times;i++){try{const t=await getPing();if(isNaN(t)){fail++;}else{pings.push(t);}}catch{fail++;}}const avg=pings.reduce((a,b)=>a+b,0)/pings.length||0;const jitter=Math.sqrt(pings.reduce((a,b)=>a+Math.pow(b-avg,2),0)/pings.length)||0;const packetLoss=(fail/times*100).toFixed(1);return{jitter:jitter.toFixed(1),packetLoss};}

// ===== Alerts =====
function checkAlerts(ping,jitter,packetLoss,download,upload){
let thresholds=JSON.parse(localStorage.getItem('thresholds'))||{ping:150,jitter:30,packet:5,download:10,upload:5};
let msgs=[]; if(ping>thresholds.ping)msgs.push('High Ping!'); if(jitter>thresholds.jitter)msgs.push('High Jitter!'); if(packetLoss>thresholds.packet)msgs.push('Packet Loss!'); if(download<thresholds.download)msgs.push('Slow Download!'); if(upload<thresholds.upload)msgs.push('Slow Upload!');
document.getElementById('alerts').innerText=msgs.join(' | ');
document.getElementById('alerts').style.color=msgs.length>0?'var(--alert)':'var(--good)';
if(msgs.length>0 && Notification.permission==='granted'){new Notification('LinkOn Alert',{body:msgs.join(' | ')})}
}

// ===== Health Score =====
function calculateHealthScore(ping,jitter,packetLoss,download,upload){
let score=0;
score+=Math.max(0,100-ping)*0.2;
score+=Math.max(0,100-jitter)*0.15;
score+=Math.max(0,100-packetLoss*20)*0.25;
score+=Math.min(download,100)*0.2;
score+=Math.min(upload,100)*0.2;
return Math.round(score);
}
function updateHealthGauge(ping,jitter,packetLoss,download,upload){
const score=calculateHealthScore(ping,jitter,packetLoss,download,upload);
healthGauge.data.datasets[0].data[0]=score;
healthGauge.data.datasets[0].data[1]=100-score;
healthGauge.data.datasets[0].backgroundColor[0]=score>=80?'var(--good)':score>=50?'var(--warn)':'var(--alert)';
healthGauge.update();
document.getElementById('healthText').innerText=score;
updateStatusBanner(score);
}
function updateStatusBanner(score){
const banner=document.getElementById('statusBanner');
if(score>=80){banner.style.backgroundColor='var(--good)';banner.innerText=`Excellent Network (${score})`;}
else if(score>=50){banner.style.backgroundColor='var(--warn)';banner.innerText=`Moderate Network (${score})`;}
else{banner.style.backgroundColor='var(--alert)';banner.innerText=`Poor Network (${score})`;}
}

// ===== Server Table =====
function renderServerTable(){
const tbody=document.querySelector('#serverTable tbody');tbody.innerHTML='';
servers.forEach(s=>{
  const hist=serverPingHistory[s]||[]; 
  const min=hist.length?Math.min(...hist):'--'; 
  const max=hist.length?Math.max(...hist):'--'; 
  const avg=hist.length?(hist.reduce((a,b)=>a+b,0)/hist.length).toFixed(1):'--';
  tbody.innerHTML+=`<tr><td>${s}</td><td>${min}</td><td>${max}</td><td>${avg}</td></tr>`;
});
}
function renderServerChart(){
serverData.labels=Object.keys(serverPingHistory)[0]?Object.keys(serverPingHistory[Object.keys(serverPingHistory)[0]]).map((_,i)=>i+1):[];
serverData.datasets=[];Object.keys(serverPingHistory).forEach((s,i)=>{
  serverData.datasets.push({label:s,data:serverPingHistory[s],borderColor:`hsl(${i*60},70%,50%)`,fill:false});
});serverChart.update();
}

// ===== CSV Export =====
function exportCSV(){
const rows=[['IP','ISP','Location','Ping','Jitter','PacketLoss','Download','Upload','NetType']];
rows.push([document.getElementById('ip').innerText,document.getElementById('isp').innerText,document.getElementById('location').innerText,document.getElementById('ping').innerText,document.getElementById('jitter').innerText,document.getElementById('packetloss').innerText,document.getElementById('download').innerText,document.getElementById('upload').innerText,document.getElementById('netType').innerText]);
let csv='';rows.forEach(r=>{csv+=r.join(',')+'\n';});
const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='network_data.csv';a.click();URL.revokeObjectURL(url);
}

// ===== Notifications =====
if(Notification.permission!=='granted')Notification.requestPermission();

// ===== Hybrid Geolocation =====
async function getAccurateLocation(){
  return new Promise(async resolve=>{
    const geoAsked=localStorage.getItem('geoAsked');
    if('geolocation' in navigator && geoAsked!=='true'){
      navigator.geolocation.getCurrentPosition(
        pos=>{localStorage.setItem('geoAsked','true'); resolve({lat:pos.coords.latitude,lon:pos.coords.longitude,accuracy:pos.coords.accuracy})},
        async ()=>{localStorage.setItem('geoAsked','true'); const ipLoc=await getGeoInfo(await getIP()); resolve({lat:ipLoc.lat,lon:ipLoc.lon,accuracy:'IP-based'})},
        {enableHighAccuracy:true,timeout:10000,maximumAge:0}
      );
    }else{
      const ipLoc=await getGeoInfo(await getIP());
      resolve({lat:ipLoc.lat,lon:ipLoc.lon,accuracy:'IP-based'});
    }
  });
}

// ===== Main Network Analysis =====
async function analyzeNetwork(){
  document.getElementById('netType').innerText='Detecting...';
  const ip=await getIP();document.getElementById('ip').innerText=ip;
  const geo=await getGeoInfo(ip);document.getElementById('isp').innerText=geo.isp;document.getElementById('location').innerText=geo.location;
  const loc=await getAccurateLocation();
  userMarker.setLatLng([loc.lat,loc.lon]);map.setView([loc.lat,loc.lon],8);
  
  const ping=await getPing();document.getElementById('ping').innerText=ping;
  const download=await getDownloadSpeed();document.getElementById('download').innerText=download;
  const upload=await getUploadSpeed();document.getElementById('upload').innerText=upload;
  const jp=await measureJitterPacketLoss();document.getElementById('jitter').innerText=jp.jitter;document.getElementById('packetloss').innerText=jp.packetLoss;

  updateHealthGauge(ping,jp.jitter,jp.packetLoss,download,upload);
  checkAlerts(ping,jp.jitter,jp.packetLoss,download,upload);

  // Update charts
  if(pingData.labels.length>=20){pingData.labels.shift();pingData.datasets[0].data.shift();}
  pingData.labels.push(new Date().toLocaleTimeString());pingData.datasets[0].data.push(ping);pingChart.update();
  if(speedData.labels.length>=20){speedData.labels.shift();speedData.datasets[0].data.forEach(d=>d.data.shift());}
  speedData.labels.push(new Date().toLocaleTimeString());speedData.datasets[0].data.push(download);speedData.datasets[1].data.push(upload);speedChart.update();

  // Update server pings
  for(const s of servers){try{const sp=await fetch(s,{method:'HEAD'}).then(_=>Date.now()).catch(_=>0);serverPingHistory[s]=serverPingHistory[s]||[];serverPingHistory[s].push(sp);if(serverPingHistory[s].length>20)serverPingHistory[s].shift();}catch{}}
  renderServerTable();renderServerChart();

  document.getElementById('netType').innerText=navigator.connection?navigator.connection.effectiveType||'N/A':'N/A';
}
renderServers();
analyzeNetwork();
setInterval(analyzeNetwork,60000); // auto-refresh every 60s
</script>

</body>
</html>
